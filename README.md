# 階層フォルダのファイルフラット化・復元ツール

> **注意:**
> 本ツールは「ファイルのフラット化・復元」専用であり、外部システムへのアップロード機能は含みません。
> また、バイナリ実行時やダウンロード時にWindowsやセキュリティソフト（Defender等）から「レアなファイル」「不明な発行元」等の警告が表示される場合があります。
> これはウイルスではなく、配布直後や利用実績が少ない新規バイナリに対する一般的な警告です。詳細情報から実行を選択してください。

> **大量ファイルをデータベースに一括登録したいけど、階層構造は受け入れてくれない…？**
> そんな時は「ファイル名にパス情報を埋め込んでフラット化」！
> サブフォルダも含めて、すべてのファイルを1つのフォルダにまとめてアップロードできます。
> 
> **入れ子フォルダも一発変換！**

![Python](https://img.shields.io/badge/python-3.9%2B-blue)

## 概要
階層構造を持つフォルダ内のファイルをフラット化し、元の構造情報を保持したまま別ディレクトリにコピー・保存します。filemapやファイル名から元の構造を復元でき、GUI（Tkinter）とCLIの両方に対応しています。

---

## 動作環境
- **OS:** Windows 10 以降 (64bit)
- **Python:** 3.9 以降
- **GUI:** Tkinter
- **配布:** PyInstallerによるスタンドアロンバイナリ（オプション）

---

## 主な機能
- 階層フォルダのファイルを「パス埋め込みファイル名（__区切り＋___エスケープ方式）」またはZIP化でフラット化
- filemap（CSV/JSON）による元構造の完全復元
- 除外/ZIP推奨拡張子のGUI指定・親子連動チェック
- ZIP化/除外指定のツリービュー操作（カラムクリックでON/OFF）
- プログレス・統計・色分け・進捗ラベルのリアルタイム表示
- 入出力フォルダ・設定の自動保存
- ヘルプボタン（❓）で詳細な使い方ガイドをいつでも表示
- 復元時のfilemap優先/ファイル名推測・ZIP展開ON/OFF切替
- **フラット名生成・復元仕様は「__（ダブルアンダースコア）区切り＋___（トリプルアンダースコア）エスケープ」方式で、可読性と復元性を両立**

---

## できないこと・今後の予定
- CLIモード（コマンドライン操作）
- 多言語対応
- filemap強化
- 変換前後のツリー可視化ファイル出力
- 除外ファイルカスタマイズUI
- 処理ログ保存・フィルタUI
- 高速化・大規模データ対応

---


## 使い方（バイナリ・GUI専用）

### 起動方法
BJB-PF.exe を実行してください。

### フラット化手順
1. 「入力フォルダ」「出力フォルダ」を選択
2. [スキャン]ボタンで内容を確認
3. 必要に応じてZIP化/除外指定や拡張子設定を編集
4. 「フラット化実行」ボタンでフラット化を開始
5. 完了後、出力フォルダにフラット化ファイル・filemap.csv等が生成されます

### 復元手順
1. [復元]モードに切り替え
2. 「入力フォルダ」（フラット化済みファイル群）と「出力フォルダ」を選択
3. filemap優先/ファイル名推測・ZIP展開ON/OFFを選択
4. 「復元実行」ボタンで元の階層に復元

※ 詳細な使い方ガイドはアプリ内ヘルプ（❓ボタン）からも参照できます

---

## 出力例
- フラット化ファイル群（例：`dir1__dir2__file.txt`、`foo___bar.txt` など）
- ZIPファイル（任意）
- filemap.csv または .json

---

## ユースケース例
- 電子顕微鏡の観察データとEDS分析データを安全かつ分離して保存

---

## データ種別ごとのZIP化活用例・ZIP化推奨拡張子の役割

写真データとEDS分析データなど、異なる性質のデータが混在する場合の活用例です。

- 写真データ（例：JPG, PNGなど）は単体で意味があるため、フラット化しても個別ファイルとして扱えます。
- 一方、EDS分析データなどは「ディレクトリ単位でひとまとまり」として意味を持つため、フラット化時にそのディレクトリごとZIP化してまとめておくのが有効です。
- このツールでは、ZIP化推奨拡張子（例：EDSデータ特有の拡張子）が含まれるディレクトリを自動的にZIP化対象として整理できます。
- これにより、単体で意味を持つファイルと、ディレクトリ単位で管理すべきデータを適切に分離してフラット化・復元できます。

---

---

## ファイル名ベース復元の実用例（拡張子変換後の階層復元）

本ツールでフラット化したファイルを外部システム等にアップロードした際、
システム側でファイルの拡張子や内容が変換される場合があります（例: `aaaaaa.dm3` → `aaaaaa.png`）。
この場合でも、ファイル名にパス情報が埋め込まれているため、
ダウンロードした変換後ファイル群（例: `sample__exp1__aaaaaa.png`）を本ツールの「ファイル名ベース復元」機能で
元のディレクトリ構造に再配置できます。

### 典型的な流れ

1. 元ファイル: `sample/exp1/aaaaaa.dm3`
2. フラット名: `sample__exp1__aaaaaa.dm3`
3. 外部システムで `aaaaaa.dm3` → `aaaaaa.png` などに変換（ファイル名は維持）
4. 取得ファイル: `sample__exp1__aaaaaa.png`
5. 本ツールで復元 → `sample/exp1/aaaaaa.png` のように階層を再現

### ポイント
- 拡張子が変わっても、ファイル名ベースで階層復元が可能
- filemapがなくてもディレクトリ構造だけは正確に再現できる
- 「ファイル名維持＋拡張子変換」なシステムとの相性が非常に良い

### 注意
- 元の拡張子（例: `.dm3`）はfilemapがないと復元できませんが、ディレクトリ構造はファイル名から復元できます
- 変換後のファイル（`.png`, `.jpg`など）は、元の階層に自動で整理できます

---

---

## 入出力サンプル
```text
[入力]
EM_data/SampleA_低倍率/img1.tif
EM_data/SampleA_高倍率/img2.tif
EM_data/SampleA_EDS/eds1.dat

[出力]
EM_data_flat_20250714/SampleA__低倍率__img1.tif
EM_data_flat_20250714/SampleA__高倍率__img2.tif
EM_data_flat_20250714/SampleA__EDS.zip
EM_data_flat_20250714/filemap.csv
```

---

## フォルダ構成
```

---

## フラット名生成・復元仕様（v0.2.4～）

- パス区切りは「__」（ダブルアンダースコア）
- 元の「__」は「___」（トリプルアンダースコア）にエスケープ
- 元の「___」は「___UNDERSCORE___」に一時エスケープ
- 日本語や記号はエンコードせず可読性重視
- 復元時は逆変換（`restore_flattened_filename`）で元パスを再現

例：

| 元パス                | フラット名                       |
|:----------------------|:---------------------------------|
| foo/bar/baz.txt       | foo__bar__baz.txt                |
| foo__bar/baz.txt      | foo___bar__baz.txt               |
| foo___bar/baz.txt     | foo___UNDERSCORE___bar__baz.txt  |
| データ/サンプル_01.txt | データ__サンプル_01.txt           |
| dir/___/file.txt      | dir___UNDERSCORE____file.txt      |

※ エスケープ文字列・区切り文字は設定で変更可能
flatten_app/
  main.py
  gui.py
  cli.py
  flattener/
    logic.py
    filemap.py
  resources/
    image/
      nanote_01.png
      nanote_02.png
      nanote_03.png
      nanote_04.png
      CNTS.png
      nanote_sab_01.png
      nanote_sab_02.png
      nanote_sab_03.png
      spinner.gif
      icon/
        icon1.ico
        icon1.png
        icon2.ico
        icon2.png
    icon.ico
```

---


## 開発・テスト方針
詳細な開発方針・テスト方針・ログ記録例は `TEST_REFACTOR_LOG.md` をご参照ください。

---

## 今後の拡張予定
- CLIモード・多言語対応・filemap強化
- 変換前後のツリー可視化ファイル出力
- 除外ファイルカスタマイズUI
- 処理ログ保存・フィルタUI
- 高速化・大規模データ対応

---

## テスト・リファクタ履歴
詳細なテスト・リファクタ履歴は `TEST_REFACTOR_LOG.md` をご参照ください。
